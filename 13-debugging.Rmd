# Debugowanie {#debugging}

Używając pakietów i funkcji stworzonych przez inne osoby możemy czasem znaleźć się w sytuacji, gdy zamiast wyniku otrzymujemy komunikat błędu.
Warto wówczas upewnić się czy nie napisaliśmy żadnej literówki i podaliśmy odpowiednie argumenty funkcji.
Konieczne kolejne kroki mogą obejmować sprawdzenie pliku pomocy danej funkcji, czy też skopiowanie najważniejszego fragmentu błędu i wklejenie go do wyszukiwarki internetowej. 
Isnieje szansa, że ktoś już wcześniej napotkał ten problem, zadał pytanie i otrzymał na nie odpowiedź w internecie (np, na https://stackoverflow.com/).

Czasem się może jednak okazać, że odkryliśmy nowy problem - warto go wtedy zgłosić do twórców pakietu.
Wiele pakietów na platformie CRAN zawiera sekcję *BugReports*, gdzie można znaleźć link do zgłaszania błędów.
Przykładowo, pakiet **stringr** jest opisany pod adresem https://cran.r-project.org/package=stringr i w jego sekcji *BugReports* znajduje się odnośnik do https://github.com/tidyverse/stringr/issues.
W przypadku zgłaszania błędów zazwyczaj nie należy pisać bardzo długich opisów czy wklejać cały kod, który został napisany.
Konieczne jest natomiast przygotowanie powtarzalnego przykładu (ang. *reproducible example*), czyli minimalnego kodu możliwego do odtworzenia problemu na innym komputerze (sekcja \@ref(reprex)).
Warto jednak pamiętać, że sekcja *Issue* na platformie Github służy głównie do zgłaszania problemów, a nie do zadawania pytań.
W przypadku potrzeby zadania pytania, lepszym pomysłem jest opublikowanie go na https://stackoverflow.com/,

Tworzenie kodu możliwego do odtworzenia problemu (powtarzalnych przykładów) jest też pomocne w przypadku, gdy my piszemy nowe skrypty i funkcje i napotkamy na błędy.
Jest to często część debugowania (ang. *debugging*) - procesu rozwiązywania problemów i błędów w oprogramowaniu.
Istnieje wiele potencjalnych taktyk debugowania kodu, w tym debugowanie używając funkcji print, czy też debugowanie interaktywne.

<!-- Reprodukcja błędu -->
<!-- Wyizolowanie źródła błędu -->
<!-- Identyfikacja przyczyny awarii -->
<!-- Usunięcie defektu -->
<!-- Weryfikacja powodzenia naprawy -->


## Powtarzalne przykłady {#reprex}

Powtarzalny przykład oznacza fragment kodu, który może być odtworzony przez inną osobę na innym komputerze/przez siebie samego w przyszłości.
Może on służyć pokazaniu poprawnego rozwiązania, wskazaniu na błędy w funkcjach, lub też jako załącznik do prośby o pomoc z kodem.
Powtarzalny przykład powinien składać się przynajmniej z:

- Z małego zbioru danych wystarczającego do odtworzenia obliczeń.
- Krótkiego kodu, który może być uruchomiony na powyższym zbiorze danych.

Czasem ważne są też dodatkowe informacje o używanej wersji R, posiadanym systemie operacyjnym, wersjach używanych pakietów, etc. 
Można do tego użyć funkcji `sessionInfo()` 

### Pakiet **reprex**

Stworzenie powtarzalnego przykładu w R może zostać ułatwione używając pakietu **reprex**. 
Ten pakiet uruchamia wybraną część kodu, wykonuje kolejne operacje, a następnie zapisuje uzyskany wynik do schowka.

Pakiet **reprex** można zainstalować poprzez funkcję `install.packages()`:

```{r 17-appendix-reprex-1, eval = FALSE}
install.packages("reprex")
```

Główną funkcją w tym pakiecie jest `reprex()`.
Funkcję `reprex()` można też użyć poprzez wpisanie kodu wewnątrz tej funkcji lub też poprzez wybranie opcji `Reprex selection` z menu Addins w RStudio.
Możliwe jest również stworzenie powtarzalnego przykładu na podstawie skryptu R:

```{r 17-appendix-reprex-2, eval=FALSE}
reprex(input = "moj_skrypt.R")
```

### Tworzenie powtarzalnego przykładu

#### Prosty przykład

Sprawdźmy działanie pakietu **reprex** na prostym przykładzie - tworzymy dwa obiekty `x` i `y`, nadajemy im wartości a następnie mnożymy je przez siebie:

```{r 17-appendix-reprex-3, eval=FALSE}
library(reprex)
reprex({
        x = 1
        y = 5
        x * y
})
```

Po jego uruchomieniu otrzymujemy wynik zapisany w schowku jako Markdown oraz w postaci wyświetlonego HTMLa:

![](figs/reprex1.png)

#### Złożony przykład

Spróbujmy teraz trochę bardziej skomplikowanego przykładu.
Naszym celem jest stworzenie mapy punktowej temperatury na podstawie obiektu **punkty**.
Powtarzalny przykład może posłużyć do szybkiego określenia problemów z kodem:

```{r 17-appendix-reprex-4, eval=FALSE}
library(reprex)
reprex({
        library(sf)
        data(punkty)
        plot(punkty["temperatura"])
})
```

Powyższy kod ma dwa problemy - czy jesteś w stanie je wskazać?

![](figs/reprex2.png)

Odpowiedź - ten kod nie jest w pełni samowystarczalny - brakuje tam dołączenia pakietu **geostatbook**, który zawiera zbiór danych `punkty`.
Drugi problem to użyta zmienna do wizualizacji - `"temperatura"` nie istnieje w zbiorze danych `punkty`. 
Zamiast niej powinna być użyta poprawna nazwa zmiennej - `"temp"`.
Naprawiona wersja tego kodu znajduje się poniżej:

```{r 17-appendix-reprex-5, eval=FALSE}
library(reprex)
reprex({
        library(sf)
        library(geostatbook)
        data(punkty)
        plot(punkty["temp"])
})
```

![](figs/reprex3.png)

W efekcie otrzymujemy nie tylko kod użyty do obliczeń, ale również wynikową grafikę.

#### Więcej informacji

- [Oficjalna strona pakietu reprex](https://reprex.tidyverse.org/index.html)
- [So you’ve been asked to make a reprex](https://www.jessemaegan.com/post/so-you-ve-been-asked-to-make-a-reprex/)
- [How to make a great R reproducible example](https://stackoverflow.com/questions/5963269/how-to-make-a-great-r-reproducible-example)
- [Magic reprex](https://www.njtierney.com/post/2017/01/11/magic-reprex/)
- [reprex: help me help you!](https://speakerdeck.com/jennybc/reprex-help-me-help-you)
- [Get help!](https://www.tidyverse.org/help/#reprex)




<!-- 4. fix an error and add tests  -->

<!-- ref intro -->

<!-- resources -->
<!-- https://rstats.wtf/debugging-r-code.html -->
<!-- https://rstudio-education.github.io/hopr/debug.html -->
<!-- https://jennybc.github.io/wtf-2019-rsc/debugging.pdf -->
<!-- https://blog.davisvaughan.com/2019/04/05/debug-r-package-with-cpp/ -->
<!-- https://bookdown.org/rdpeng/RProgDA/debugging.html -->
<!-- https://adv-r.hadley.nz/debugging.html -->
<!-- https://www.youtube.com/watch?time_continue=1&v=R3-IMGyNJY4 -->
<!-- https://support.rstudio.com/hc/en-us/articles/205612627-Debugging-with-RStudio -->
<!-- http://kevinushey.github.io/blog/2015/04/13/debugging-with-lldb/ -->
<!-- https://github.com/wch/r-debug/blob/master/debugging-r.md -->

## Podstawowe podejście do debugowania

<!-- `print()`, `cat()` - small objects -->
<!-- `str()` - large object trunct -->
<!-- test values -->

<!-- `traceback()` - bottom to top -->

## Interaktywne debugowanie

<!-- ## inside R -->

<!-- `browser()` -->

<!-- `n` - next statement -->
<!-- `c` - continue -->
<!-- `s` step into function call -->
<!-- `f` finish loop/funciton -->
<!-- `where` previous calls -->
<!-- `Q` quit debugger -->

<!-- + RStudio gui -->
<!-- + brakepoints -->

<!-- ## inside R 2-->

<!-- `debug()`, `trace()`, `recover()` -->

## Zadania

<!-- create debugging examples - .R files -->
<!-- https://github.com/jimhester/wtf-debugging -->